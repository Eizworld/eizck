<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<title>User Dashboard</title>
</head>
<body class="bg-light">

<div class="container py-3">

<div class="card p-3 mb-3">
<h5>ğŸ‘¤ My Profile</h5>
<div id="info"></div>
</div>

<div class="card p-3 mb-3">
<h5>ğŸš Meal History</h5>
<div id="mealList"></div>
</div>

<div class="card p-3 mb-3">
<h5>ğŸ“Š Monthly Bill</h5>
<div id="bill"></div>
</div>

<div class="card p-3">
<h5>ğŸ“¢ Notice</h5>
<div id="notice"></div>
</div>

</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { doc, getDoc, collection, getDocs, query, where } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const user = auth.currentUser;
const snap = await getDoc(doc(db,"users",user.uid));

info.innerHTML = `
Name: ${snap.data().name}<br>
Room: ${snap.data().room}<br>
Total Meal: ${snap.data().totalMeal}
`;

let totalMeal=0,totalCost=0;
(getDocs(collection(db,"users"))).then(s=>s.forEach(d=>totalMeal+=d.data().totalMeal));
(getDocs(collection(db,"costs"))).then(s=>{
 s.forEach(d=>totalCost+=d.data().amount);
 const rate = totalCost/totalMeal;
 bill.innerHTML = `Meal Rate: ${rate.toFixed(2)} à§³<br>
 Your Bill: ${(rate*snap.data().totalMeal).toFixed(2)} à§³`;
});

const q = query(collection(db,"meals"),where("uid","==",user.uid));
(getDocs(q)).then(s=>{
 s.forEach(d=>{
  mealList.innerHTML += `<p>${d.data().date} â€” ğŸš ${d.data().meal}</p>`;
 });
});

(getDocs(collection(db,"notice"))).then(s=>{
 s.forEach(d=>notice.innerHTML+=`<p>ğŸ“¢ ${d.data().text}</p>`);
});
</script>

</body>
</html>